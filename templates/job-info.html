{% extends 'user-base.html' %}
  
{% load static %}

{% block title %}
Job {{ job.id }}
{% endblock %}

{% block javascript %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js" integrity="sha512-G8JE1Xbr0egZE5gNGyUm1fF764iHVfRXshIoUWCTPAbKkkItp/6qal5YAHXrxEu4HNfPTQs6HOu3D5vCGS1j3w==" crossorigin="anonymous"></script>
<script>
function renderChart(data, label) {
    var ctx = document.getElementById('myChart').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [{
                label: label,
                borderColor: 'rgb(0, 0, 0)',
		fill: false,
		pointRadius: 0,
		data: data
            }]
        },
        options: {
            legend: {
	        display: false
	    },
            scales: {
                xAxes: [{
                    type: 'time',
                    distribution: 'linear',
		    time: {
                    displayFormats: {
                        hour: 'HH',
                        minute: 'HH:mm',
		        second: 'HH:mm:ss'}
		    }
	        }]
	    }
        }
    });
}

function getChartData(job_id) {
    $("#loadingMessage").html('<span data-feather="loader"></span>');
    $.ajax({
        url: "/jobs/" + job_id + "/usage/",
        success: function (result) {
            $("#loadingMessage").html("");
            renderChart(result.memory, 'Memory');
        },
        error: function (err) {
            $("#loadingMessage").html("Error");
        }
    });
}

$(document).ready(function () {
    getChartData({{ job.id }});
});
</script>
{% endblock %}

{% block contentuser %}
<h2><a href="#" onclick="history.go(-1)"><i class="feather-32" data-feather="arrow-left"></i></a> Job {{ job.id }}
{% if job.name %}
: {{ job.name }}
{% endif %}
</h2>

<div class="project-tab">
<div class="container">
<ul class="nav nav-tabs">
  <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#details">Details</a></li>
  <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#monitoring">Monitoring</a></li>
  <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#statistics">Statistics</a></li>
</ul>

<div class="tab-content">
  <div id="details" class="tab-pane fade show active">
  <br/>

<b>Status</b>
<br/>
{% if job.status == "running" %}
<i class="text-primary fa fa-repeat" aria-hidden="true"></i> Running
{% elif job.status == "failed" %}
<i class="text-danger fa fa-exclamation-circle" aria-hidden="true"></i> Failed
{% elif job.status == "deleted" %}
<i class="text-secondary fa fa-minus-circle" aria-hidden="true"></i> Deleted
{% elif job.status == "killed" %}
<i class="text-warning fa fa-exclamation-circle" aria-hidden="true"></i> Killed
{% elif job.status == "pending" %}
<i class="text-info fa fa-circle" aria-hidden="true"></i> Pending
{% elif job.status == "completed" %}
<i class="text-success fa fa-check-circle" aria-hidden="true"></i> Completed
{% endif %}

{% if job.statusReason %}
<br/>
<br/>
<b>Status reason</b>
<br/>
{{ job.statusReason }}
{% endif %}

<br/>
<br/>
<b>Site</b>
<br/>
{% if job.execution.site %}
{{ job.execution.site }}
{% else %}
Not yet assigned
{% endif %}

<br/>
<br/>
<b>Labels</b>
<br/>
{% for key, value in job.labels.items %}
{{ key }}: {{ value }}<br/>
{% empty %}
None<br/>
{% endfor %}

<br/>
<b>Resources</b>
<br/>
{{ job.resources.nodes }} nodes,
{{ job.resources.cpus }} CPUs,
{{ job.resources.memory }} GB memory,
{{ job.resources.disk }} GB disk

<br/>
<br/>
<b>Tasks</b>
<br/>
{% for task in job.tasks %}
<table>
  <tr><td>Container image</td><td>{{ task.image }}</td></tr>
  <tr><td>Container runtime</td><td>{{ task.runtime }}</td></tr>
  <tr><td>Command</td><td>{{ task.cmd }}</td></tr>
</table>
{% endfor %}

<br/>
<b>Input files</b>
<br/>
{% for input in job.inputs %}
{{ input.filename }}
{% empty %}
None
{% endfor %}

<br/>
<br/>
<b>Artifacts</b>
<br/>
{% for artifact in job.artifacts %}
{{ artifact.url }} <br/>
{% empty %}
None <br/>
{% endfor %}

<br/>
<b>Storage</b>
<br/>
{% if job.storage %}
<table>
<tr><td>Type</td><td>{{ job.storage.type }}</td></tr>
{% if job.storage.type == "onedata" %}
<tr><td>Provider</td><td>{{ job.storage.onedata.provider }}</td></tr>
{% else %}
<tr><td>URL</td><td>{{ job.storage.webdav.url }}</td></tr>
{% endif %}
<tr><td>Mountpoint</td><td>{{ job.storage.mountpoint }}</td></tr>
</table>
{% else %}
None
{% endif %}

{% if job.parameters %}
<br/>
<br/>
<b>Parameters</b>
<table>
{% for key, value in job.parameters.items %}
<tr><td>{{ key }}:</td><td>{{ value }}</td></tr>
{% endfor %}
</table>
{% endif %}

  </div>
  <div id="monitoring" class="tab-pane fade">
  <br/>
    <div class="container px-0">
      <div class="col-sm-8 px-0">
        <div class="card px-0">
          <div class="card-body">
		  <h5 class="card-title">Memory utilisation (MB)</h5>
            <div class="container">
              <div class="row">
                <canvas id="myChart" width="800" height="400"></canvas>
	      </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<div id="statistics" class="tab-pane fade">
  <br/>
<b>Events</b>
<br/>
<table class="table table-sm table-borderless w-25">
  <tr><td>Created</td><td style="text-align:right">{{ job.events.createTime }}</td></tr>
  <tr><td>Start time</td><td style="text-align:right">{{ job.events.startTime }}</td></tr>
  <tr><td>End time</td><td style="text-align:right">{{ job.events.endTime }}</td></tr>
</table>
<br/>

<b>Tasks</b><br/>
{% for task in job.execution.tasks %}
<table class="table table-sm table-borderless w-25">
<tr><td>Image pull time</td><td style="text-align:right">{{ task.imagePullTime|floatformat:"0" }}</td></tr>
<tr><td>Exit code</td><td style="text-align:right">{{ task.exitCode }}</td></tr>
<tr><td>CPU time</td><td style="text-align:right">{{ task.cpuTimeUsage|floatformat:"0" }}</td></tr>
<tr><td>Wall time</td><td style="text-align:right">{{ task.wallTimeUsage|floatformat:"0" }}</td></tr>
<tr><td>Retries</td><td style="text-align:right">{{ task.retries }}</td></tr>
</table>
{% endfor %}
  </div>

</div>
</div>

<br/>
<br/>

{% endblock %}
